# =============================================================================
# DataNucleus JDO Configuration for Wildbook
# Optimized for Azure Standard D8s v5 (8 vCPUs, 32 GB RAM)
# CONSERVATIVE changes only - no behavior modifications that could cause exceptions
# =============================================================================

# -----------------------------------------------------------------------------
# DATABASE CONNECTION (unchanged from original)
# -----------------------------------------------------------------------------
datanucleus.ConnectionDriverName=org.postgresql.Driver
datanucleus.ConnectionURL=jdbc:postgresql://db:5432/wildbook

javax.jdo.PersistenceManagerFactoryClass=org.datanucleus.api.jdo.JDOPersistenceManagerFactory
datanucleus.ConnectionUserName=wildbook
datanucleus.ConnectionPassword=wildbook

# -----------------------------------------------------------------------------
# SCHEMA MANAGEMENT (unchanged from original)
# -----------------------------------------------------------------------------
datanucleus.schema.autoCreateAll=true

# -----------------------------------------------------------------------------
# PERSISTENCE MANAGER SETTINGS (unchanged from original)
# -----------------------------------------------------------------------------
datanucleus.storeManagerType=rdbms
datanucleus.NontransactionalRead=true
datanucleus.Multithreaded=true
datanucleus.RestoreValues=true

# -----------------------------------------------------------------------------
# FETCH CONFIGURATION (UNCHANGED - keeping original behavior)
# -----------------------------------------------------------------------------
# Keep unlimited fetch depth to avoid LazyInitializationException
datanucleus.maxFetchDepth=-1

# Keep eager loading to avoid LazyInitializationException on collections
datanucleus.cache.collections.lazy=false

# -----------------------------------------------------------------------------
# CONNECTION POOLING (DBCP2) - SAFE IMPROVEMENTS
# These changes improve connection handling without changing application behavior
# -----------------------------------------------------------------------------
datanucleus.connectionPoolingType=dbcp2

# Increased pool size to handle more concurrent users (was 30)
datanucleus.connectionPool.maxActive=200

# Increased idle connections for faster response (was 10)
datanucleus.connectionPool.maxIdle=50

# Increased minimum idle to keep connections warm (was 5)
datanucleus.connectionPool.minIdle=20

# Keep unlimited wait to match original behavior
datanucleus.connectionPool.maxWait=-1

# Connection validation (was already present)
datanucleus.connectionPool.testSQL=SELECT 1

# NEW: Validate connections before use (prevents stale connection errors)
datanucleus.connectionPool.testOnBorrow=true
datanucleus.connectionPool.testWhileIdle=true

# Eviction settings (was 240000, now more frequent)
datanucleus.connectionPool.timeBetweenEvictionRunsMillis=60000
datanucleus.connectionPool.minEvictableIdleTimeMillis=300000

# -----------------------------------------------------------------------------
# STATEMENT CACHING - SAFE IMPROVEMENT
# Caches prepared statements to reduce database parsing overhead
# This is transparent to the application
# -----------------------------------------------------------------------------
datanucleus.rdbms.statementCaching=true
datanucleus.rdbms.statementCaching.maxSize=100

# -----------------------------------------------------------------------------
# QUERY COMPILATION CACHE - SAFE IMPROVEMENT
# Caches compiled JDOQL queries to avoid re-parsing
# This is transparent to the application
# -----------------------------------------------------------------------------
datanucleus.query.compilation.cache.type=soft
datanucleus.query.compilation.cache.maxSize=500

