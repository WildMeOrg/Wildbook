⏺ WildEx Backend Logic Specification

  Overview

  The backend processes Wildbook annotation exports, downloads encounter images, crops them using bounding boxes, and organizes them by Individual ID. It supports resume functionality for failed
  downloads.

  ---
  Core Components

  1. Entry Point: performFinalSave()

  Location: src/utils.ts:254

  Inputs:
  - submitData: SubmitData - User configuration from UI
    - inputXlsx: Path to Excel file (or resume file)
    - downloadRoot: Output directory
    - unidentifiedEncounters: Include annotations without Individual IDs
    - numAnnotationsPerId: How many annotations per ID (1-10 or "all")
  - originalXlsx: string - If truthy, indicates resume mode (tracks original source file)

  Outputs:
  - Done object:
    - success: boolean - Whether all downloads succeeded
    - message: string - Summary or error description
    - errorsExcelFilePath?: string - Path to resume file (if errors occurred)

  ---
  2. Excel Processing: getGroupedAnnotationsFromExcel()

  Location: src/utils.ts:173

  Process:
  1. Read Excel (readExcelToJSON() @ line 49)
    - Uses xlsx library to parse the first sheet
    - Converts to JSON array with default empty strings for missing values
  2. Flatten Multi-Annotation Rows (lines 188-231)
    - Wildbook exports can have multiple annotations per encounter row (Annotation0, Annotation1, etc.)
    - Iterates through each annotation index and creates separate rows
    - Validation checks (lines 198-207):
        - Skip if MatchAgainst !== 'true'
      - Skip if ViewPoint is empty
      - Skip if imageUrl is empty
      - Skip if bbox is empty or 'null' string
    - Normalizes all annotations to Annotation0.* fields
    - Marks extra rows with "Annotation.extrarow": 'true' flag
    - Handles missing/empty Individual IDs → sets to "Unidentified_annotations"
  3. Group by Individual ID (lines 235-245)
    - Groups annotations by Name0.value (Individual ID)
    - Filters out unidentified if unidentifiedEncounters === false
  4. Shortlist Annotations (shortlistAnnotations() @ line 54)
    - Applies viewpoint selection logic based on numAnnotationsPerId

  ---
  3. Viewpoint Selection: shortlistAnnotations()

  Location: src/utils.ts:54

  Strategy:
  - For 1 annotation: Prefer left, fallback to right, then similar viewpoints, then any
  - For 2-5+: Follow priority order: left → right → front → back → up
    - First tries exact match
    - Then similar viewpoints (e.g., frontleft for left)
    - Finally any available annotation
  - "all" or count ≥ available: Returns all annotations unchanged

  Matching Logic (pullAnnotationRow() @ line 112):
  - "exact": Exact viewpoint string match
  - "similar": Viewpoint string contains target (e.g., "frontleft" matches "left")
  - "any": First available annotation

  Mutation: Removes selected annotations from the input array (destructive)

  ---
  4. Download & Processing Loop

  Location: src/utils.ts:293-358

  Folder Structure:
  downloadRoot/
  └── {filename-without-extension}/
      ├── {IndividualID_1}/
      │   ├── image1.jpg
      │   └── image2.jpg
      ├── {IndividualID_2}/
      │   └── image3.jpg
      └── Unidentified_annotations/
          └── image4.jpg

  For each Individual ID:
  1. Create folder: {downloadRoot}/{filenameWithoutExtension}/{IndividualID}/
  2. For each annotation:
    - Extract filename from Encounter.mediaAsset0 (add .jpg if no extension)
    - Download image from Encounter.mediaAsset0.imageUrl
    - Parse bounding box: "x,y,w,h" → [x, y, w, h]
    - Crop using sharp library
    - Save to: {IndividualIDFolder}/{filename}.jpg

  Error Handling:
  - Collects failed annotations in errors object
  - Skips extra rows (flagged with "Annotation.extrarow": 'true') from error Excel (line 343-346)
  - Tracks original row data + wildExErrorMessage field
  - Continues processing remaining annotations

  ---
  5. Resume File Generation

  Location: src/utils.ts:360-389

  When errors occur:
  1. Creates Excel file: {originalFilename}.resume.xlsx
  2. Sheet 1: "Search Results" - Failed annotation rows with error messages
  3. Sheet 2: "Resume Information" - Original SubmitData configuration
  4. Saved to wrapping folder alongside downloaded images

  Resume Detection: checkIfResumeFile() @ src/common.ts:4
  - Checks if filename contains .resume. before extension

  ---
  6. Halt Mechanism

  Location: src/utils.ts:248-252

  - Global flag haltFinalSaveFlag
  - Set via IPC call from UI cancel button
  - Checked before:
    - Creating folders (line 298)
    - Downloading images (line 320)
  - Throws "Canceled by user" error when triggered

  ---
  7. Image Processing: downloadCropAndSaveImage()

  Location: src/utils.ts:39

  Pipeline:
  1. fetch() image URL → ArrayBuffer
  2. sharp() library extracts region:
    - left: x-coordinate
    - top: y-coordinate
    - width: crop width
    - height: crop height
  3. Preserves EXIF metadata (withMetadata())
  4. Writes to file

  ---
  Data Flow

  UI (SubmitData)
      ↓
  [IPC: handle-final-submit]
      ↓
  performFinalSave()
      ↓
  getGroupedAnnotationsFromExcel()
      ├→ readExcelToJSON() - Parse Excel
      ├→ Flatten multi-annotation rows
      ├→ Validate & filter
      ├→ Group by Individual ID
      └→ shortlistAnnotations() - Apply viewpoint logic
      ↓
  [For each Individual ID]
      ├→ Create folder
      └→ [For each annotation]
          ├→ downloadCropAndSaveImage()
          │   ├→ fetch(imageUrl)
          │   ├→ sharp.extract(bbox)
          │   └→ save to file
          └→ [On error] → Add to errors object
      ↓
  [If errors]
      ├→ Generate resume Excel file
      └→ Return { success: false, errorsExcelFilePath }
  [Else]
      └→ Return { success: true }

  ---
  Key Features

  Resume Mode

  - UI detects .resume.xlsx files via checkIfResumeFile()
  - Reads config from "Resume Information" sheet
  - Disables UI parameter changes (locked to original values)
  - Passes originalXlsx to track source file
  - Overwrites existing resume file each run (line 367)

  Duplicate Handling

  - Extra annotation rows (from multi-annotation encounters) excluded from error Excel (line 343-346)
  - Prevents duplicate entries in resume files

  Validation

  - Skips annotations with:
    - MatchAgainst !== 'true'
    - Empty/null bounding boxes
    - Missing image URLs or viewpoints
  - Recent fix: Added empty/null bbox checks (PR #6)

  ---
  Error Scenarios

  | Error                              | Behavior                                          |
  |------------------------------------|---------------------------------------------------|
  | Malformed Excel                    | Returns immediately with error message            |
  | Cannot create wrapping folder      | Returns immediately                               |
  | Cannot create Individual ID folder | Marks all annotations for that ID as errors       |
  | Download/crop failure              | Marks annotation as error, continues              |
  | User cancels                       | Throws error for current download, marks as error |