services:
  db:
    image: postgres:13.4
    container_name: db
    healthcheck:
      # More robust check: verify PostgreSQL can actually execute a query
      # pg_isready only checks if accepting connections, not if responsive
      test: [ "CMD-SHELL", "pg_isready -U ${WILDBOOK_DB_USER:-wildbook} -d ${WILDBOOK_DB_NAME:-wildbook} && psql -U ${WILDBOOK_DB_USER:-wildbook} -d ${WILDBOOK_DB_NAME:-wildbook} -c 'SELECT 1' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      logging: "alloy"
      service: "postgresql"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "database"
      autoheal: "true"
    user: postgres
    volumes:
      - db-pgdata-var:/var/lib/postgresql/data
      # DB initialization scripts
      - .dockerfiles/db/initdb.d/:/docker-entrypoint-initdb.d/
      - .dockerfiles/db/postgresql.conf:/etc/postgresql/postgresql.conf
      # Shared with Alloy:
      - postgresql-logs:/var/log/postgresql
    networks:
      - intranet
    ports:
      # TODO on deployment: exposed for developer verification, close after
      - 5433:5432
    command: -c config_file=/etc/postgresql/postgresql.conf
    shm_size: 4gb
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      WBIA_DB_NAME: "${WBIA_DB_NAME}"
      WBIA_DB_USER: "${WBIA_DB_USER}"
      WBIA_DB_PASSWORD: "${WBIA_DB_PASSWORD}"
      WILDBOOK_DB_NAME: "${WILDBOOK_DB_NAME}"
      WILDBOOK_DB_USER: "${WILDBOOK_DB_USER}"
      WILDBOOK_DB_PASSWORD: "${WILDBOOK_DB_PASSWORD}"

  wildbook:
    image: tomcat:9.0.113-jre17-temurin-jammy
    container_name: wildbook
    depends_on:
      db:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      logging: "alloy"
      service: "wildbook"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "application"
      autoheal: "true"
    entrypoint: /docker-entrypoint.sh
    volumes:
      - "$WILDBOOK_BASE_DIR/wb-docker-deploy/wildbook_docker_webapps/:/usr/local/tomcat/webapps/"
      - "$WILDBOOK_BASE_DIR/wildbook_data_dir/:/usr/local/tomcat/webapps/wildbook_data_dir/"
      - "$WILDBOOK_BASE_DIR/wb-docker-deploy/logs/:/usr/local/tomcat/logs/"
      - /var/run/docker.sock:/var/run/docker.sock
      - .dockerfiles/tomcat/server.xml:/usr/local/tomcat/conf/server.xml
      - .dockerfiles/docker-entrypoint.sh:/docker-entrypoint.sh
      #- .dockerfiles/tomcat/commonConfiguration.properties:/usr/local/tomcat/webapps/wildbook_data_dir/WEB-INF/classes/bundles/commonConfiguration.properties
      #- .dockerfiles/tomcat/IA.json:/usr/local/tomcat/webapps/wildbook_data_dir/WEB-INF/classes/bundles/IA.json
    networks:
      - intranet
    ports:
      # TODO on deployment: exposed for developer verification, close after
      - "81:8080"
    healthcheck:
      # TODO on deployment:  change test.example.org to desired url ... this wildbook?
      test: [ "CMD-SHELL", "curl --fail-with-body ${WILDBOOK_URL} || exit 1" ]
      interval: 180s
      timeout: 60s
      retries: 3
      start_period: 60s
    restart: always
    environment:
      DB_USER: "${WILDBOOK_DB_USER}"
      DB_PASSWORD: "${WILDBOOK_DB_PASSWORD}"
      DB_CONNECTION_URL: "${WILDBOOK_DB_CONNECTION_URL}"
      # Admin user created on startup,
      # https://github.com/WildMeOrg/Wildbook/commit/6d65e70e43691f1b281bb76edf151e5c7cdb7403
      ADMIN_EMAIL: "${EDM_AUTHENTICATIONS_USERNAME__DEFAULT}"
      ADMIN_PASSWORD: "${EDM_AUTHENTICATIONS_PASSWORD__DEFAULT}"
      # JAVA_OPTS from old-world wildbook, which gives us 16G heap memory
      JAVA_OPTS: "-Djava.awt.headless=true -Xms16g -Xmx16g"
      SERVICE_NAME: "${SERVICE_NAME:-wildbook}"
      ENVIRONMENT: "${ENVIRONMENT:-production}"
      DOMAIN_NAME: "${DOMAIN_NAME:-unknown}"
      HOSTNAME: "${HOSTNAME:-localhost}"
      WILDBOOK_LOG_LEVEL: "${WILDBOOK_LOG_LEVEL:-INFO}"

  opensearch:
    image: opensearchproject/opensearch:2.15.0
    container_name: opensearch
    healthcheck:
      # Check cluster health and verify status is not "red"
      # Green = all shards allocated, Yellow = primary shards ok, Red = cluster down
      test: [ "CMD-SHELL", "curl --silent --fail 127.0.0.1:9200/_cluster/health | grep -qE '\"status\":\"(green|yellow)\"' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      logging: "alloy"
      service: "opensearch"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "search"
      autoheal: "true"
    volumes:
      - opensearch-var1:/usr/share/opensearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    networks:
      - intranet
    ports:
      # development exposure, not exposed in production
      - 9200:9200
      - 9300:9300
    environment:
      - plugins.security.disabled=true
      - node.name=opensearch
      #- discovery.seed_hosts=elasticsearch2,elasticsearch3
      #- cluster.initial_master_nodes=elasticsearch,elasticsearch2,elasticsearch3
      #- discovery.seed_hosts=opensearch2
      - cluster.initial_master_nodes=opensearch
      - bootstrap.memory_lock=true
      - cluster.routing.allocation.disk.threshold_enabled=${ES_THRESHOLD:-true}
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - "OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD}"

  # https://hub.docker.com/r/boky/postfix/
  #  TODO dkim and spf needs to be added/supported
  smtp:
    image: boky/postfix
    container_name: smtp
    healthcheck:
      # Check if postfix master process is running
      test: [ "CMD-SHELL", "pgrep -x master || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      logging: "alloy"
      service: "smtp"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "infrastructure"
      autoheal: "true"
    networks:
      - intranet
    ports:
      - $MAIL_PORT:587
    volumes:
      - .dockerfiles/smtp/dkim-keys:/etc/opendkim/keys
    environment:
      - "HOSTNAME=${MAIL_HOSTNAME}"
      - "ALLOWED_SENDER_DOMAINS=${MAIL_ALLOWED_SENDER_DOMAINS}"
      - "RELAYHOST=${MAIL_RELAYHOST}"
      - "RELAYHOST_USERNAME=${MAIL_RELAYHOST_USERNAME}"
      - "RELAYHOST_PASSWORD=${MAIL_RELAYHOST_PASSWORD}"

  nginx:
    image: nginx:1.23.4
    container_name: nginx
    depends_on:
      - wildbook
    healthcheck:
      # Check if nginx master process is running and can accept connections
      # nginx:1.23.4 doesn't include curl, so we check the pid file and use nginx -t
      test: [ "CMD-SHELL", "nginx -t 2>/dev/null && kill -0 $(cat /var/run/nginx.pid 2>/dev/null) || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      logging: "alloy"
      service: "nginx"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "proxy"
      autoheal: "true"
    volumes:
      - .dockerfiles/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - /etc/letsencrypt:/etc/letsencrypt
      # Shared log volume: Alloy reads from /logs/nginx/
      - "$WILDBOOK_BASE_DIR/wb-docker-deploy/logs/nginx:/var/log/nginx"
    networks:
      - intranet
    ports:
      # BBB deprecated in favor or port 80, remains for backward compat
      - "80:80"
      - "443:443"

  alloy:
    image: grafana/alloy:v1.12.2
    container_name: alloy
    # Run with elevated permissions to access Docker socket
    user: root
    labels:
      logging: "alloy"
      service: "alloy"
      environment: "${ENVIRONMENT:-production}"
      domain: "${DOMAIN_NAME:-unknown}"
      log_type: "infrastructure"
      autoheal: "true"
    volumes:
      - .dockerfiles/alloy/config.alloy:/etc/alloy/config.alloy
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock:ro
      - "$WILDBOOK_BASE_DIR/wb-docker-deploy/logs:/logs:ro"
      - postgresql-logs:/logs/postgresql:ro
      - alloy-data:/var/lib/alloy
      # This volume mount will fail gracefully on macOS/Windows
      - type: bind
        source: ${DOCKER_CONTAINERS_PATH:-/var/lib/docker/containers}
        target: /var/lib/docker/containers
        read_only: true
        # Note: This mount will fail on macOS/Windows but won't stop the container
        # Alloy will fall back to using Docker API instead
    command:
      - run
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
      - /etc/alloy/config.alloy
    ports:
      - "12345:12345"  # Alloy UI for debugging
    environment:
      - HOSTNAME=${HOSTNAME:-localhost}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DOMAIN_NAME=${DOMAIN_NAME:-unknown}
      - LOKI_URL=${LOKI_URL:-http://host.docker.internal:3100/loki/api/v1/push}
      - LOKI_USERNAME=${LOKI_USERNAME}
      - LOKI_PASSWORD=${LOKI_PASSWORD}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - intranet
    restart: unless-stopped

  autoheal:
    image: willfarrell/autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      AUTOHEAL_CONTAINER_LABEL: "autoheal"
      AUTOHEAL_INTERVAL: 15
      AUTOHEAL_START_PERIOD: 600
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60
    restart: always

networks:
  intranet:

volumes:
  db-pgdata-var:
  opensearch-var1:
  alloy-data:
  postgresql-logs: